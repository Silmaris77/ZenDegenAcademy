import streamlit as st
import os
import sys
import traceback
from config.settings import PAGE_CONFIG

# Ta funkcja musi byƒá wywo≈Çana jako pierwsza funkcja Streamlit
st.set_page_config(**PAGE_CONFIG)

# ≈öcie≈ºka do g≈Ç√≥wnego katalogu aplikacji (dla import√≥w)
APP_DIR = os.path.dirname(os.path.abspath(__file__))
if APP_DIR not in sys.path:
    sys.path.append(APP_DIR)

# Pozosta≈Çy import - pr√≥bujemy z obs≈ÇugƒÖ b≈Çƒôd√≥w
try:
    from utils.session import init_session_state, clear_session
    from utils.components import zen_header, navigation_menu
    from views.login import show_login_page
    from views.dashboard import show_dashboard
    from views.degen_test import show_degen_test
    from views.lesson import show_lesson
    from views.profile import show_profile
    from views.degen_explorer import show_degen_explorer
    from views.skills_new import show_skill_tree
    try:
        from views.shop_new import show_shop  # U≈ºywamy nowej wersji sklepu
    except ImportError:
        def show_shop():
            st.title("Sklep üõí")
            st.error("Sklep jest obecnie niedostƒôpny. Spr√≥buj ponownie p√≥≈∫niej.")
except Exception as e:
    st.error(f"B≈ÇƒÖd podczas importowania modu≈Ç√≥w: {str(e)}")
    st.code(traceback.format_exc())

# Za≈Çaduj plik CSS
def load_css(css_file):
    with open(css_file, "r", encoding="utf-8") as f:
        css = f.read()
    return css

# ≈öcie≈ºka do pliku CSS
css_path = os.path.join(os.path.dirname(__file__), "static", "css", "style.css")
css = load_css(css_path)
st.markdown(f"<style>{css}</style>", unsafe_allow_html=True)

def main():
    # Initialize session state
    init_session_state()
    
    # Sidebar for logged-in users
    if st.session_state.logged_in:
        with st.sidebar:
            st.markdown(f"### Witaj, {st.session_state.username}!")
            
            # Nawigacja
            navigation_menu()
            
            # Przycisk wylogowania na dole sidebara
            if st.button("Wyloguj siƒô", key="logout_button"):
                clear_session()
                st.rerun()
                
    # Page routing
    if not st.session_state.logged_in:
        show_login_page()
    else:
        if st.session_state.page == 'dashboard':
            show_dashboard()
        elif st.session_state.page == 'degen_test':
            show_degen_test()
        elif st.session_state.page == 'lesson':
            show_lesson()
        elif st.session_state.page == 'profile':
            show_profile()
        elif st.session_state.page == 'degen_explorer':
            show_degen_explorer()        elif st.session_state.page == 'skills':
            show_skill_tree()
        elif st.session_state.page == 'shop':
            try:
                # Only call shop_new.py implementation
                from views.shop_new import show_shop
                show_shop()
            except Exception as e:
                st.error(f"B≈ÇƒÖd podczas ≈Çadowania sklepu: {e}")
                import traceback
                st.code(traceback.format_exc())

st.markdown("""
<style>
div.stButton > button { 
    margin-bottom: 1px; 
}

/* Poprawa widoczno≈õci tekstu w przyciskach przy r√≥≈ºnych stanach */
div.stButton > button:hover {
    color: #000000 !important; /* Czarny tekst dla lepszego kontrastu */
    font-weight: bold;
}

/* Przyciski z niebieskim t≈Çem */
section[data-testid="stSidebar"] div.stButton > button:hover,
div.stButton > button[kind="primary"]:hover {
    color: black !important; /* Bia≈Çy tekst na niebieskim tle */
    text-shadow: 0 0 2px rgba(0,0,0,0.5); /* Cie≈Ñ tekstu dla lepszej widoczno≈õci */
    font-weight: bold;
}

/* Przyciski w aplikacji - "POKA≈ª LEK", "ANALITYKA" itp. */
button[kind="secondary"] {
    color: black !important;
    text-shadow: 0 0 2px rgba(0,0,0,0.5); 
    font-weight: bold !important;
}

button[kind="secondary"]:hover {
    color: white !important;
    background-color: var(--primary-color) !important;
}

/* Style poprawiajƒÖce responsywno≈õƒá na urzƒÖdzeniach mobilnych */
@media (max-width: 768px) {
    /* Zwiƒôkszenie obszaru klikalnego dla element√≥w rozwijanego menu */
    .st-expander {
        padding: 10px 0;
    }
    
    /* Zwiƒôkszenie rozmiaru czcionki w rozwijanym menu */
    .st-expander .st-expander-header {
        font-size: 1.2rem !important;
        padding: 15px 10px !important;
    }
    
    /* Zapewnienie wystarczajƒÖcej przestrzeni dla zawarto≈õci rozwijanej */
    .st-expander .st-expander-content {
        padding: 12px !important;
    }
    
    /* Dodanie wyra≈∫nego wska≈∫nika dotyku */
    .st-expander .st-expander-header:after {
        content: '‚ñº';
        margin-left: 8px;
        font-size: 0.8rem;
    }
    
    .st-expander.st-expander-expanded .st-expander-header:after {
        content: '‚ñ≤';
    }
}
</style>
""", unsafe_allow_html=True)

if __name__ == "__main__":
    main()